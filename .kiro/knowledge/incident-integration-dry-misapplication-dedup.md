# Incident: DRY原則の誤適用による重複排除仕様の統合

## Metadata

| Field | Value |
|-------|-------|
| Discovered Phase | impl |
| Should Detect At | requirements |
| Category | integration |
| Keywords | DRY, 重複排除, deduplication, 仕様統合, コンテキスト分離 |
| Severity | medium |

## Problem Summary

**DRY原則を表面的に適用し、本来分離すべき異なるコンテキストの仕様を統合してしまった**

「同じ重複排除という要件」という表面的な類似性に着目し、Monitor（ヘルスチェック）とAPI（外部エラー報告）の重複排除仕様を共通化した。しかし、両者は報告の内容も性質も異なり、重複排除の判定条件も本来異なるべきだった。

## Concrete Example

### What Was Specified
- Monitor: 同一サービスの繰り返し障害を重複抑制
- API: 同一内容のエラー報告を重複抑制
- 共通: SlackNotifierのDeduplicationTrackerで一元管理

### What Was Missing
- **MonitorとAPIで「同一」の定義が異なることの明示**
  - Monitor: 同じURLの障害 → response_bodyが変わっても同一
  - API: 同じstatus + details → 内容が違えば別のエラー

### What Happened
```
1. 外部システムからHTTP 403エラーを報告 → Slack通知
2. 同じシステムからHTTP 500エラーを報告 → 「重複」として抑制
3. 実際には異なるエラーなのに通知されなかった
```

運用者が重要なエラー（500）を見逃すリスクが発生した。

### Why It Was Overlooked
- 「重複排除」という機能名の類似性に惑わされた
- DRY原則を「同じ名前の機能は統合すべき」と誤解した
- レビューで「要件が分散している」という指摘を受け、深く検討せず統合した
- MonitorとAPIのユースケースの違いを仕様レベルで分析しなかった

## Detection Points by Phase

### requirements
- [ ] 同じ機能名でも、異なるコンテキストで使われる場合は「同一性の定義」を明示しているか
- [ ] DRY原則の適用を検討する際、「何が重複しているのか」を具体的に列挙しているか
- [ ] 統合候補の機能について、入力の性質・頻度・目的の違いを分析しているか

### design
- [ ] 共通化するコンポーネントが、異なるコンテキストからの入力を適切に区別できるか
- [ ] 「同じインターフェース」が「同じセマンティクス」を意味するか確認しているか

### tasks
- [ ] 共通コンポーネントのテストケースに、異なるコンテキストからの入力パターンが含まれているか

### impl
- [ ] 実装時に「このキー設計で異なるコンテキストが衝突しないか」を検証しているか

## General Checklist

| 観点 | 確認事項 |
|------|----------|
| コンテキストの違い | 入力元、頻度、目的、期待される振る舞いが異なるか |
| 同一性の定義 | 何をもって「同じ」とするかがコンテキストごとに異なるか |
| DRY適用の妥当性 | 「コードの重複」と「概念の重複」を区別しているか |
| 将来の拡張性 | 統合により、一方の変更が他方に意図せず影響しないか |

## Related Patterns

| Pattern | Common Oversight |
|---------|------------------|
| キャッシュキー設計 | 異なるドメインのデータを同じキャッシュで管理し衝突 |
| イベントハンドラ統合 | 異なるイベントタイプを同じハンドラで処理し、条件分岐が複雑化 |
| バリデーション共通化 | 異なるコンテキストで許容値が異なるのに同じルールを適用 |

## Lessons Learned

1. **DRY原則は「知識の重複」を避けるもので、「コードの類似」を避けるものではない**
2. **「同じ機能名」≠「同じ要件」：コンテキストが異なれば要件も異なる**
3. **レビューで「分散している」と指摘されたら、統合の前に「なぜ分散しているのか」を分析する**
