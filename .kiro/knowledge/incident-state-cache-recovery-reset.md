# 状態リセット漏れパターン: 回復時のキャッシュクリア

## メタ情報

| 項目 | 値 |
|------|-----|
| 発見フェーズ | impl |
| 本来の検出フェーズ | requirements |
| カテゴリ | state |
| キーワード | キャッシュ, 重複抑制, 状態遷移, TTL, 回復, クリア |
| 重要度 | 高 |

## 問題の本質

**状態を持つ機能において、「状態遷移時のリセット処理」が仕様から漏れる**

これは特に「正常系」に注力して仕様を書いた場合に発生しやすい。状態の「作成」「更新」「参照」は書くが、「クリア条件」を書き忘れる。

## 具体例: 通知の重複抑制

### 仕様として書かれていたこと
- 同一内容の通知は一定時間（例: 300秒）内に重複送信しない
- 通知種別・対象・ステータスの組み合わせで重複を判定する
- 重複抑制された通知はログに記録する

### 仕様として書かれていなかったこと
- **回復通知を送信したとき、該当対象の重複抑制キャッシュをクリアする**

### 何が起きたか
```
1. サービスA: 異常検知 → アラート送信 ✅
   （キャッシュに "alert:serviceA:unhealthy" を記録）

2. サービスA: 回復検知 → 回復通知送信 ✅
   （キャッシュはそのまま）

3. サービスA: 再度異常検知 → アラート送信されない ❌
   （キャッシュに "alert:serviceA:unhealthy" が残存、重複と判定）
```

ユーザーから見ると「回復した後に再度障害が起きたのに通知が来ない」という深刻な問題。

### なぜ見落としたか
- 「重複抑制」の仕様を書く際、「同じ状態が続く」シナリオだけを想定
- 「状態が変わって戻る」シナリオ（異常→回復→異常）を想定していなかった
- TTL（時間切れ）でのクリアは考慮していたが、イベント駆動のクリアを考慮していなかった

## 各フェーズでの検出ポイント

### requirements（仕様策定時）
**最も効果的な検出タイミング**

チェック質問:
- [ ] この機能は状態を持つか？（キャッシュ、フラグ、カウンター、トラッカーなど）
- [ ] その状態は「いつ」「どのような条件で」クリアされるか明記しているか？
- [ ] 状態遷移（正常→異常→正常など）が起きたとき、関連する状態はどうなるべきか？

具体的な問い:
> 「Xが発生したらYをキャッシュする」と書いたら、
> 「Xが解消したらYのキャッシュはどうなるべきか？」も書く

### design（設計時）
チェック質問:
- [ ] 状態を持つコンポーネントに対して、クリア用のインターフェースは定義されているか？
- [ ] シーケンス図に「状態クリア」の操作が含まれているか？
- [ ] 「回復」「リセット」「再開」などの遷移で、影響を受ける状態を列挙しているか？

### tasks（タスク定義時）
チェック質問:
- [ ] 状態クリアのテストケースがタスクに含まれているか？
- [ ] 「正常→異常→正常→異常」のような往復シナリオのテストがあるか？

### impl（実装時）
チェック質問:
- [ ] 実際に往復シナリオを手動で試したか？
- [ ] キャッシュ/状態の中身をデバッグログで確認したか？

## 汎用チェックリスト: 状態管理機能

仕様に「状態を保持する」機能が含まれる場合、以下を確認:

### 1. クリア条件の明文化
| クリア種別 | 確認項目 |
|-----------|---------|
| 時間ベース | TTL、有効期限は定義されているか |
| イベント駆動 | どのイベントでクリアされるか |
| 手動 | 管理者によるクリア手段は必要か |
| 再起動 | プロセス再起動時の挙動は定義されているか |

### 2. 状態遷移との整合性
「回復」「完了」「キャンセル」「リセット」などの遷移が発生したとき:
- 関連するキャッシュはクリアすべきか、保持すべきか
- 関連するカウンターはリセットすべきか、継続すべきか
- 関連するフラグは解除すべきか、維持すべきか

### 3. よくある見落としパターン

| パターン | 見落としやすいクリア条件 |
|---------|------------------------|
| 重複抑制 | 回復時、対象変更時 |
| サーキットブレーカー | 回復時（half-open → closed） |
| レート制限 | 制限解除時、設定変更時 |
| リトライカウンター | 成功時、タイムアウト時 |
| セッション | ログアウト時、権限変更時 |
| キャッシュ | 元データ更新時、無効化イベント時 |
| ロック | タイムアウト時、所有者変更時 |

## 教訓

1. **「正常系」の仕様は書きやすいが、「状態遷移時の副作用」は見落としやすい**
2. **「Xを記録する」と書いたら「Xをクリアする条件」も必ず書く**
3. **往復シナリオ（A→B→A）を仕様策定時点で意識する**
4. **状態を持つコンポーネントは、シーケンス図で「クリア」操作を明示する**
