# Session Handover
**Generated**: 2026-02-22
**Branch**: main
**Session Goal**: Roadmap Router化 + ファイルベースレビュー + SubAgent防止

## Direction
### Immediate Next Action
ユーザー判断待ち。v0.18.0 リリース完了。全15 spec implementation-complete。

### Active Goals
- [x] Roadmap Router化 — /sdd-roadmap を統合エントリポイント化 (v0.18.0)
- [x] Agent 定義移動 — .claude/agents/ → sdd/settings/agents/ (SubAgent spawn 防止)
- [x] File-based review — SendMessage 排除、.review/ ディレクトリベース
- [x] Recovery Protocol 廃止 — Lead 自己判断で retry
- [x] シナリオ検証 19件実施、6件の問題修正
- [x] install.sh --local 追加

### Key Decisions
**Continuing from previous sessions:**
1. 細かめ粒度 (15 spec) を採用 (ref D2)
2. 全 spec を `implementation-complete` で作成 — 既存実装が正 (ref D1)
3. 6 Wave 構成 (ref D2)
4. cpf-protocol は横断的仕様、改修時は3 spec 影響確認必要
5. Write Fallback Protocol — knowledge buffer に記録
6. release-automation Spec 7 追加 (ref D4)
7. installer downstream Skip (ref D5)
8. CLAUDE.md Change Request Triage ルール追加 (ref D6)
9. Auto-Fix Loop ownership — 各レビュー spec が standalone canonical (ref D8)
10. Auditor timeout は実装裁量、固定値なし (ref D9)
11. Agent Teams API 依存をフォールバックなしで受容 (ref D10)
12. dead-code review は verdict-only (ref D11)

**Added this session:**
13. Roadmap 常時必須 — 個別コマンドは廃止、全て /sdd-roadmap 経由 (ref D19)
14. Router化 — /sdd-roadmap に design/impl/review サブコマンド追加 (ref D19)
15. Agent 定義を sdd/settings/agents/ に移動 — .claude/agents/ からの SubAgent spawn を構造的に排除 (ref D19)
16. ファイルベースレビュー — Inspector が .review/{name}.cpf に書き出し、Auditor が読み込み verdict.cpf を書く。SendMessage 不要 (ref D19)
17. Recovery Protocol 廃止 — ファイルベースで冪等なので特別な手順不要。Lead が自己判断で retry (ref D19)
18. Revise Mode: steering 更新を Architect spawn 前に実施（product.md だけでなく全 steering 対象）(ref D19)

### Warnings
- **Retroactive spec 15件は v0.18.0 の構造変更を反映していない** — 既存 spec の design.md は旧アーキテクチャ（SendMessage ベース、.claude/agents/ 参照等）を前提。改修時は revise 経由で更新すること
- **Cross-check Tracked issues 27件** (H8, M15, L6) — `verdicts-cross-check.md` 参照。実装ブロックなし
- **template drift 10/15 spec** — Error Handling / Testing Strategy / Specs Traceability セクション欠落（体系的）
- `.claude/` 配下はインストール先。編集対象は `framework/` のみ。反映は `bash install.sh --local --force`

## Session Context
### Tone and Nuance
ユーザーは効率重視。正規パイプライン経由を徹底。
「動くか？」を重視 — シナリオシミュレーションで齟齬を網羅的に検出する姿勢。
アーキテクチャ変更に対して「プロコンをちゃんと提示」を求める。
Recovery は過剰設計 — Lead に判断を委ねるべきという方針。

### Steering Exceptions
なし

## Accomplished
- **Roadmap Router化** (7 commits → v0.18.0)
  - /sdd-roadmap: design/impl/review サブコマンド追加
  - 個別コマンド (sdd-design/impl/review) → redirect stub
  - Single-Spec Roadmap Ensure: roadmap なしで auto-create、既存 roadmap に auto-add
  - 1-Spec Roadmap Optimizations: Wave QG skip
  - CLAUDE.md: Roadmap Required ルール、Stages 書き換え
- **Agent 定義移動** (22 files)
  - framework/claude/agents/ → framework/claude/sdd/settings/agents/
  - YAML frontmatter 除去、model hint のみ残存
  - SKILL.md: "Read profile → embed → spawn via TeammateTool" を全箇所に明示
  - install.sh: v0.18.0 マイグレーション追加
- **File-based review pipeline**
  - Inspector → .review/{name}.cpf ファイル書き出し
  - Auditor → .cpf 読み込み + verdict.cpf 書き出し
  - Lead → verdict.cpf 読み → verdicts.md 永続化 → .review/ 削除
  - Consensus N≥2: .review-{p}/ ディレクトリ分離
  - Wave QG: .review-wave-{N}/ と .review-wave-{N}-dc/
  - SendMessage 完全排除（review pipeline から）
- **Recovery Protocol 廃止** → Teammate Failure Handling (3行) に簡素化
- **シナリオ検証 19件** — 6件の問題修正（dead-code routing, design mode detection, etc.）
- **install.sh --local** — 開発用ローカルインストール
- **Revise Mode steering 更新** — Architect spawn 前に全 steering 対象
- **v0.18.0 リリース** (tag + release branch + main push)

### Modified Files
- `VERSION`, `README.md`, `install.sh`
- `framework/claude/CLAUDE.md`
- `framework/claude/skills/sdd-roadmap/SKILL.md` (大幅拡張)
- `framework/claude/skills/sdd-design/SKILL.md` (redirect stub)
- `framework/claude/skills/sdd-impl/SKILL.md` (redirect stub)
- `framework/claude/skills/sdd-review/SKILL.md` (redirect stub)
- `framework/claude/skills/sdd-status/SKILL.md` (参照更新)
- `framework/claude/skills/sdd-steering/SKILL.md` (参照更新)
- `framework/claude/skills/sdd-knowledge/SKILL.md` (参照更新)
- `framework/claude/sdd/settings/agents/` (22 files: 移動 + frontmatter 除去 + ファイルベース化)
- `framework/claude/agents/` (削除)

## Resume Instructions
1. `session.md` を読み込み、Direction と Warnings を確認
2. 既存 retroactive spec 15件は旧アーキテクチャ前提 — 改修時は `/sdd-roadmap revise` 使用
3. 反映は `bash install.sh --local --force`（リモートではなくローカル framework/ からコピー）
